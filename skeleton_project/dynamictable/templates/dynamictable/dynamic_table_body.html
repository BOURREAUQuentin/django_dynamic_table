<table class="table" id="table">
    <thead>
        {% for col in columns %}
            <th>{{ col.name }}</th>
        {% endfor %}
        <th><button uk-toggle="target: #my-id" class="bg-blue-500 text-white p-2">+</button></th>
    </thead>
    <tbody id="table-body">
        {% for row in rows %}
            <tr>
                {% for cell in row %}
                    <td>
                        {% if cell.type == 'tag' %}
                        <div class="relative">
                            <select 
                                id="tag-select-{{ cell.cel_id }}" 
                                style="background-color: {{ cell.tag_color }}; color: white;"
                                onchange="updateTagColor(this, {{ cell.cel_id }})"
                                class="border p-2 rounded">
                                
                                <!-- option "Sélectionner" si aucun tag n'est sélectionné par défaut -->
                                {% if not cell.value %}
                                    <option disabled value="" selected style="background-color: #f5f5f5; color: black;">
                                        Sélectionner
                                    </option>
                                {% endif %}

                                {% for tag_option in cell.tag_options %}
                                    <option 
                                        value="{{ tag_option.value }}" 
                                        style="background-color: {{ tag_option.color }}; color: white;"
                                        {% if cell.value == tag_option.value %}selected{% endif %}>
                                        {{ tag_option.value }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% elif cell.type == 'date' %}
                            <input  type="date"
                                    name="new_value"
                                    value="{{ cell.value }}"
                                    hx-post="{% url 'dynamictable:update_cell' cell.cel_id %}"
                                    hx-trigger="change"
                                    class="border p-1">
                        {% elif cell.type == 'integer' %}
                            <input  type="number"
                                    name="new_value"
                                    value="{{ cell.value }}"
                                    hx-post="{% url 'dynamictable:update_cell' cell.cel_id %}"
                                    hx-trigger="change"
                                    class="border p-1">
                        {% else %}
                            <input  type="text"
                                    name="new_value"
                                    value="{{ cell.value }}"
                                    hx-post="{% url 'dynamictable:update_cell' cell.cel_id %}"
                                    hx-trigger="change"
                                    class="border p-1">
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
        <tr>
            <td>
                <button hx-get="{% url 'dynamictable:add_row' table_id %}" hx-target="#table" class="bg-blue-500 text-white p-2">+</button>
            </td>
        </tr>
    </tbody>
</table>

<script>
    function updateTagColor(selectElement, cellId) {
        // récupère la couleur de l'option sélectionnée
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const backgroundColor = selectedOption.style.backgroundColor;
    
        // applique la couleur de fond au champ sélectionné
        selectElement.style.backgroundColor = backgroundColor;

        // envoi de la requête POST pour mettre à jour la base de données
        const newValue = selectElement.value; // récupère la nouvelle valeur du tag
        fetch(`dynamictable/table/update_cellule/${cellId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCsrfToken() // Fonction pour récupérer le token CSRF
            },
            body: `new_value=${encodeURIComponent(newValue)}`
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur HTTP ${response.status}`);
            }
    
            return response.json(); // conversion du flux de la réponse en JSON
        })
        .then(data => {
            if (data.status === "success") {
                console.log("Cellule mise à jour :", data.new_value); // récupération de new_value
            } else {
                console.error("Erreur :", data.message); // affichage du message d'erreur
            }
        })
        .catch(error => console.error("Erreur de requête :", error));
    }

    // Fonction pour récupérer le token CSRF depuis les cookies
    function getCsrfToken() {
        const csrfCookie = document.cookie
            .split("; ")
            .find(row => row.startsWith("csrftoken="));
        return csrfCookie ? csrfCookie.split("=")[1] : "";
    }

</script>