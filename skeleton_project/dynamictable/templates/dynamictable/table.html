<!-- Tableau dynamique -->
<div id="dynamic-table">
    <h2>{{ name }}</h2>
    <p>{{ description }}</p>
    {% include "dynamictable/dynamic_table_body.html" %}
</div>


<div id="my-id" class="uk-modal-{{ table_id }}" uk-modal>
    <div class="uk-modal-dialog uk-modal-body">
        <h2 class="uk-modal-title">Ajouter une colonne</h2>
        <form hx-post="{% url 'dynamictable:add_column' table_id %}" hx-target="#table" hx-swap="outerHTML" hx-on="htmx:afterRequest: closeModal()">
            {% csrf_token %}
            <div class="uk-margin">
                <label for="new-column-name">Nom de la colonne :</label>
                <input id="new-column-name" name="name" class="uk-input" type="text" required>
            </div>
            <div class="uk-margin">
                <label for="new-column-type">Type de colonne :</label>
                <select id="new-column-type" name="type" class="uk-select" required>
                    <option value="Texte">Texte</option>
                    <option value="Nombre">Nombre</option>
                    <option value="Date">Date</option>
                </select>
            </div>
            <div class="uk-margin">
                <button type="button" class="uk-button uk-button-default uk-modal-close">Fermer</button>
                <button type="submit" class="uk-button uk-button-primary">Ajouter</button>
            </div>
        </form>
    </div>
</div>

<div id="edit-column-modal" class="uk-modal-{{ table_id }}" uk-modal>
    <div class="uk-modal-dialog uk-modal-body">
        <h2 class="uk-modal-title">Modifier la colonne</h2>
        <form id="edit-column-form" hx-post="" hx-target="#table-body" hx-swap="outerHTML" hx-on="htmx:afterRequest">
            {% csrf_token %}
            <input type="hidden" name="column_id" id="edit-column-id">
            <div class="uk-margin">
                <label for="edit-column-name" class="uk-form-label">Nom de la colonne</label>
                <input class="uk-input" type="text" name="column_name" id="edit-column-name" value="" required>
            </div>
            <div class="uk-margin">
                <label for="edit-column-type" class="uk-form-label">Type de colonne</label>
                <select class="uk-select" name="column_type" id="edit-column-type" value="" required>
                    <option value="Texte">Texte</option>
                    <option value="Nombre">Nombre</option>
                    <option value="Date">Date</option>
                </select>
            </div>
            <div class="uk-margin">
                <button type="button" class="uk-button uk-button-default uk-modal-close">Annuler</button>
                <button type="submit" class="uk-button uk-button-primary">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Vérifier si UIkit est correctement chargé
        if (typeof UIkit === 'undefined') {
            console.error('UIkit n\'est pas chargé correctement');
            return;
        }

        // Lors de l'ouverture du modal "Ajouter une colonne", fermer tous les dropdowns
        UIkit.util.on('#my-id', 'beforeshow', function() {
            document.querySelectorAll('.uk-navbar-dropdown').forEach(function(dropdown) {
                // S'assurer que le dropdown est bien initialisé avant de tenter de le fermer
                if (UIkit.dropdown(dropdown).isActive()) {
                    UIkit.dropdown(dropdown).hide();
                }
            });
        });

        // Lorsque le modal est fermé, réafficher tous les dropdowns
        UIkit.util.on('#my-id', 'hide', function() {
            document.querySelectorAll('.uk-navbar-dropdown').forEach(function(dropdown) {
                // Réinitialiser les dropdowns qui sont masqués ou fermés
                UIkit.dropdown(dropdown).show();
            });
        });

        // Fermeture des dropdowns sur les autres actions si nécessaire
        document.addEventListener('click', function(event) {
            if (UIkit.modal('#my-id').isActive()) {
                // Fermer tous les dropdowns si un modal est actif
                document.querySelectorAll('.uk-navbar-dropdown').forEach(function(dropdown) {
                    UIkit.dropdown(dropdown).hide();
                });
            }
        });
    });

    function closeModal() {
    // Fermer uniquement le modal actuellement actif
    const modalAdd = UIkit.modal('#my-id');
    const modalEdit = UIkit.modal('#edit-column-modal');

    if (modalAdd && modalAdd.isActive()) {
        modalAdd.hide(true);
    }

    if (modalEdit && modalEdit.isActive()) {
        modalEdit.hide(true);
    }

    // Réinitialiser les formulaires
    document.getElementById('new-column-name').value = '';
    document.getElementById('new-column-type').selectedIndex = 0;
}


// Fonction pour ouvrir le modal d'édition
function openEditModal(tableId, columnId, columnName, columnType) {
    // Vérification des données
    console.log(`Opening edit modal for Table ID: ${tableId}, Column ID: ${columnId}, Name: ${columnName}, Type: ${columnType}`);

    // Mettre à jour les champs du modal
    document.getElementById('edit-column-id').value = columnId;
    document.getElementById('edit-column-name').value = columnName;

    const columnTypeSelect = document.getElementById('edit-column-type');
    const typeMapping = {
        'integer': 'Nombre',
        'date': 'Date',
        'text': 'Texte'
    };
    columnTypeSelect.value = typeMapping[columnType] || 'Texte';

    // Construire dynamiquement l'URL pour la requête POST
    const url = `/dynamictable/table/update_column/${tableId}/${columnId}/`;
    console.log(`Generated URL: ${url}`);

    // Mettre à jour l'attribut hx-post du formulaire
    const form = document.getElementById('edit-column-form');
    form.setAttribute('hx-post', url);

    // Afficher le modal avec un délai pour s'assurer que tout est configuré
    setTimeout(() => {
        UIkit.modal('#edit-column-modal').show();
    }, 50);
}


    // Fonction pour soumettre le formulaire dynamiquement
    document.getElementById('edit-column-form').addEventListener('submit', function(event) {
        event.preventDefault();

        const form = event.target;
        const url = form.getAttribute('hx-post');
        const formData = new FormData(form);

        htmx.ajax('POST', url, {
            target: '#table-body', // Ciblez spécifiquement le corps du tableau
            swap: 'innerHTML',
            values: Object.fromEntries(formData.entries())
        });

        // Fermer le modal
        const modal = UIkit.modal('#edit-column-modal');
        if (modal) {
            modal.hide(true);
        }
    });
    

    UIkit.util.on('.uk-modal', 'beforeshow', function () {
        const modal = this;
        const currentTableId = modal.id.split('-').pop(); // Extraire le table_id de la modal en cours
        console.log(`Current table ID: ${currentTableId}`);
        cleanupModals(currentTableId); // Nettoyer les autres modales
    });

    function cleanupModals(currentTableId) {
        // Sélectionne toutes les modales présentes dans le DOM
        const modals = document.querySelectorAll('.uk-modal');

        modals.forEach(modal => {
            if (modal.id !== currentModalId && modal.id.split('-').pop() !== currentTableId) {
                UIkit.modal(modal).hide(true);
                UIkit.util.on(modal, 'hidden', function () {
                    console.log(`Cleaning up modal: ${modal.id}`);
                    modal.remove();
                });
            }
        });
    }

    
    

    


    
    
</script>
